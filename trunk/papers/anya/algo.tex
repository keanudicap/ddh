\section{Algorithm}
%The best online approaches for any-angle pathfinding consider 
%only the set of discrete points that define the grid.
%Since this strategy is insufficient to guarantee optimality 
%we will consider sets of discrete and intermediate points
%by taking them together as an interval.

\begin{defi}
\label{defi::interval}
A \emph{grid interval} $I$ is a set of contiguous pairwise visible points 
from any row of the grid.  Each interval is defined in terms 
of its endpoints $a$ and $b$. 
With the possible exception of $a$ and $b$, each interval
contains only intermediate and discrete non-corner points.
\end{defi}
Identifying intervals is simple: any row of the grid can be naturally divided
into maximally contiguous sets of traversable and non-traversable points.
Each traversable set forms a tentative interval which we split, repeatedly,
until the only corner points are found at $a$ or $b$.
\\
A significant advantage of Anya is that we construct intervals on-the-fly.
This allows us to start answering queries immediately and for any discrete
start-target pair. Similar algorithms (e.g. Continuous Dijkstra) require
a preprocessing step before any queries can be answered and then only
from a single fixed start point. 

\begin{defi}
\label{defi:searchnode}
A \emph{search node} $(I, r)$ is a tuple where $I$ is an interval and 
$r \not \in I$ is a \emph{root} point chosen s.t. each $p \in I$  
is visible from $r$. The identity of $r$ is always the most
recent turning point on a path from the start point $s$ to any $p \in I$.
To represent the start node, set $I = [s]$ and assume $r$ is a point located 
off the plane and visible only from $s$.
\end{defi}
The successors of a search node $n$ are identified by computing intervals
over sets of traversable points from the same row of the grid as $n$ and from rows
immediately adjacent. We want to guarantee that each point in such
a set can be reached from the root of $n$ via a local path which is \emph{taut}.
Taut simply means that if we ``pull'' on the endpoints of the path we cannot
make it any shorter.

\begin{figure}[tb]
  \begin{center}
    \input{tikz/ex2}
  \end{center}
  \caption{$(I, r)$ has three successors: $(I'_1, r)$ which is observable
and $(I'_2, r')$ and $(I'_3, r')$ which are not. Notice that intervals of traversable
points exist left of $I$ but the local path through $I$ to each such point is
not taut.}
\label{fig::successors}
\end{figure}

\begin{defi}
\label{defi::successors}
$(I', r')$ is a \emph{successor} of
$(I, r)$ if each $p' \in I'$ is reached
by a taut path $\langle r, p,  p' \rangle$ that begins
at $r$ and passes through some $p \in I$.  Additionally, 
the subpath $\langle p, p' \rangle$ must not intersect any 
interval $J \neq I'$.
\end{defi}
We begin with the set of traversable points that are 
visible from $r$ through $I$ and divide this set into $1 \leq k$
adjacent closed grid intervals.
We will say that each such interval is \emph{observable} and 
generate for each a corresponding successor node 
$(I', r')$ with root $r' = r$.
\\
Not all successors are observable.
For example, the taut path from $r$ can intersect 
$I$ at an endpoint $b$ which is also a corner point.
In this case we reach a set of traversable points that 
are either adjacent to $I$ or adjacent to the set of 
observable successors.
Each such point is visible from $p = b$ but not 
from $r$.  From this set of non-visible points we build a 
single half-open interval $I' = [a', b')$ s.t. $I'$ is open at the 
endpoint closest to $b$.
We will say $I'$ is \emph{non-observable} and generate a 
corresponding successor $(I', r')$ with root $r' = b$.  
Figure~\ref{fig::successors} shows examples of both
observable and non-observable successors.
%
%Notice that if $b$ is a non-corner endpoint of $I$ there 
%can also exist a set of traversable points that are not visible from $r$.
%In this case however the path from $r$ to each such point $p'$ is 
%not taut so we do not generate any successor.
\\
To evaluate a search node $n = (I, r$) we will select a point $p \in I$ 
which has a minimum $f$-value with respect to a target point $t$.
We compute: 
\begin{equation}
\label{eq::f}
f(p) = g(r) + d(r, p) + h(p, t)
\end{equation}
where $g(r)$ is the length of the optimal path from the start point to 
the root, $d(r, p)$ is the straight line distance from $r$ to $p$
and $h(p, t)$ is an admissible function that lower-bounds the cost of
reaching $t$ from $p$.
\\
Although each interval can contain a large number of points it is easy to
identify the one with minimum $f$-value: simply project a straight line $r
\rightarrow t$ from the root point $r$ to the target point $t$ and choose the
point $p \in I$ which lies at their intersection.  If $r \rightarrow t$ does not
intersect $I$, choose $p$ as one of the two endpoints of $I$.

\begin{figure}[tb]
  \begin{center}
    \input{tikz/fvalue}
  \end{center}
  \caption{An illustration of Lemma~\ref{lemm::minf}. The point $g_1$ corresponds 
to Case (i); $g_2$ and $g_3$ correspond to Case (ii); $g_4$ and $g'_4$ correspond
to Case (iii);}
\label{fig::minf}
\end{figure}

\begin{lemm}
\label{lemm::minf}
For any tuple $(I, r)$ and target point $t$: 
\textbf{if} the line $r \rightarrow t$ intersects $I$ at a point
$p$ \textbf{then} $\forall p' \in I: f(p) < f(p')$;
\textbf{else}
%If $r \rightarrow t$ does not intersect $I$ then 
$p$ is one of the two endpoints of $I$ and 
$\forall p' \in I: f(p) < f(p')$.
\end{lemm}
\begin{proof}
%By construction. 
There are three cases to consider:
(i) $r \rightarrow t$ intersects $I$; (ii) $r \rightarrow t$ intersects
the grid row containing $I$ but not $I$; (iii) $r \rightarrow t$ does 
not intersect the grid row containing $I$. Each
case is illustrated in Figure~\ref{fig::minf}.
\\
\textbf{Case (i):} $r \rightarrow t$ is a minimum bound on the cost of any
path from $r$ through $p \in I$ to $t$. Thus $f(p)$ is minimum.
\\
\textbf{Case (ii):} $r \rightarrow t$ crosses the row of $I$ 
either to the left of $I$, in which
case $p = a$, or to the right of $I$, in which case $p = b$.
In either case $f(p)$ is again a minimum bound on the cost of any
path from $r$ to $t$ through $I$.
\\
\textbf{Case (iii):} $r \rightarrow t$ does not intersect $I$ 
or even the grid row $R$ containing $I$. In this case we mirror
$t$ through $R$ and derive a point $t'$ which we use in
conjunction with Case (i) or Case (ii) instead of $t$.
To see that $t$ and $t'$ are equivalent we identify 
a point $x$ at the intersection of $t \rightarrow t'$ with $R$. 
For any $p \in I$ we can now form two adjacent right-angle
triangles: $p, x, t$ and $p, x, t'$. The opposide and adjacent 
sides of both triangles have the same length and in both cases 
meet at an angle of 90 degrees. We conclude the triangles are
congruent and that 
$\forall p \in I: p \rightarrow t \equiv p \rightarrow t'$.
\end{proof}

\section{Correctness and Optimality}
We begin by connecting the notions of \emph{taut} and \emph{optimal}.
\begin{lemm}
\label{lemma::opt_is_taut}
Every optimal path $\pi$ is also taut.
\end{lemm}
\begin{proof}
By contradiction. If $\pi$ is not taut we can apply 
Lemma~\ref{lemma::corner} to derive a path $\pi'$ which is 
shorter than $\pi$. 
%The existance of any such $\pi'$ contradicts the 
%optimality of $\pi$.
\end{proof}
Lemma~\ref{lemma::opt_is_taut} tells us that,
during optimal search, the only successors of a node which
are interesting are those reachable by a local path that is taut.
\begin{lemm}
\label{lemma::taut_successors}
Every point $p'$ can be reached by a taut local
path of the form $\langle r, p, p' \rangle$ where
r is the root of a search node $(I, r)$ and $p \in I$.
%For every point $p'$ there exists a taut local path from 
%For every search node $(I, r)$ and
%taut local path $\langle r, p, p' \rangle$ from $r$, through some 
%$p \in I$ and to a point $p'$: there exists
%a successor $(I', r')$ s.t. $p' \in I'$.
\end{lemm}
\begin{proof}
%% NB: The full proof needs to be an inductive argument
%% for the visible and non-visible cases.
%% We have to show that every point can be reached by a taut local
%% path and that the union of taut local paths is a complete cover.
%% Don't forget to point out that the start node has 0 observable successors.
Sketch. There are two cases to consider depending on whether or not $p'$ is
visible from $r$ through $I$.  If $p'$ is visible from $r$ through $I$ then it
belongs to one of the observable successors of $(I, r)$. Otherwise $p'$ belongs
to one of the non-observable successors of $(I, r)$.  The only points $p'$ not
found in any successor interval are those where the local path from $r$ through 
$I$ is not taut. Refer once more to Definition~\ref{defi::successors} and
Figure~\ref{fig::successors}.
\end{proof}
From Lemma~\ref{lemma::taut_successors} we conclude that Anya is complete: for
any search node $(I, r)$ every point on a taut local path from $r$ through
$I$ is reached through some successor $(I', r')$.  As we only have
positive cost transitions, from a node to each successor, we can be certain that
if a path exists it will eventually be returned. We now show that if Anya returns
a path that path is cost optimal.
\begin{theorem}
For any arbitrary pair of discrete points $s$ and $t$, which are connected,
Anya always finds a path $\pi = \langle s, \ldots, t\rangle$ which is
cost optimal.
\end{theorem}
\begin{proof}
Sketch only. Suppose $\pi$ is not optimal. There must be another 
path $\pi'$ which is shorter. Since $\pi'$ is shorter $\ldots$.
\\
Stuff below needs fixing. Doesn't make sense yet.
By contradiction. Suppose we return a path where
the goal has a non-optimal parent. 
This means the non-optimal parent has a priority
which is less than the priority of the optimal parent.
Equivalently, we generate the interval containing the 
optimal parent using a representative point which is
worse than the non-optimal parent.
By Lemma~\ref{lemma:fvalue} we always choose a representative
point having minimum $f$-value.
Since the optimal parent has $g(p) + h(p, t) \leq g(p') + h(p', t)$
and the representative point has an $f$ leq than this.
So we must have expanded the optimal parent first and generated
the target with an $f$ value smaller than  the one through 
the non-optimal parent.
\end{proof}

\section{Conclusion}
Some concluding remarks will conclusively conclude this paper.

\section{Stuff that is not finished}
This further constraint allows us to bound the branching factor of each
node to just those neighbours which are immediately adjacent to and on
the same row as $n$ and visible neig
as $n$ or located on an immediately adjacent 
row next to $n$.

is another significant advantage of Anya: unlike other similar
algorithms that have a (e.g. Visibility Points) we avoid generating successors that 
are not immediately promising

We will look for optimal any-angle paths in the search space formed by
intervals appearing along the rows of the grid.
%
%Our search nodes will comprise of tuples of the form $(I, r)$ where
%$I$ is an interval and $r$ is a \emph{root} point which can be
%either the start location or the most recent corner point on the path used
%to reach to $I$.
%Given any such tuple we require that each $p \in I$ is visible from $r$.
%\\

Definition~\ref{defi::intadj} bounds the branching factor of each 
search node to $O(W)$ and unlike other exact algortihms (e.g. visibility graphs)
allows us to defer the generation of any neighbours that are not 
immediately promising.
\\

Essentially, the reason why the existing algorithms are not optimal
is that the search is based on the grid intersections.  
However, because the final any-angle path 
may never cross these intersections, 
the $A^*$ $f$ value associated with the intersections
is not relevant.  
In this article, we propose to run the search not on the grid 
but instead on the edges of the graph.  

bla bla

From $n_1$, all the nodes that can be reached with a one step North 
(and potentially any fraction of West/East steps) will be considered.  
We call ``interval'' this set of nodes that are considered together.  

How should we then compute the successors of an interval?  
Look at Figure~\ref{fig::succ1} (left) 
where a North step is taken from the interval $[(1,3)-(4,3)]$
reached from node $(1,1)$.  
The (single) successor of the interval 
is simply computed by projecting the visibility cone 
(represented with dashed lines)
from $(1,1)$ to the next row.  
This leads to the interval $[(1,4)-(5+\frac{1}{2},4)]$.  
Obverse that, as a consequence, the parent of the interval 
(here $(1,1)$) must be kept together with the interval.  

\begin{figure}[ht]
  \begin{minipage}{0.5\linewidth}
  \begin{center}
    \input{tikz/ex2}
  \end{center}
  \end{minipage}
  \begin{minipage}{0.5\linewidth}
  \begin{center}
    \input{tikz/ex3}
  \end{center}
  \end{minipage}
  \caption{Computing the successors of an interval}
  \label{fig::succ1}
\end{figure}

There are more complicated situations, 
as presented in Figure~\ref{fig::succ1} (right).  
Here, we can see that an obstacle splits the interval 
in two separate intervals.  
We could define disjunct intervals, 
but it seems more natural to consider them independently.  

Furthermore, the path might turn at node $(3,3)$
(e.g., to reach node $(3,4)$
which is not directly accessible from $(1,1)$).  
The corner $(3,3)$ is therefore a successor of node $(1,1)$ 
and intervals should be built from this node.  

%Let us present more precisely how the successors are splitted.  
%From the interval $I = [(1,3)-(4,3)]$, 
%we assume that an epsilon step 
%(i.e., an infinitely small step North) is taken.  
%This step reveals how the interval will be splitted.  
%Therefore, we generate interval 
%$[(1,3+\varepsilon)-(4+\frac{3}{2}\varepsilon,3+\varepsilon)]$; 
%we then remove the parts that belong to the obstacle, 
%which produces the two intervals 
%$[(1,3+\varepsilon)-(2,3+\varepsilon)]$ 
%$[(3,3+\varepsilon)-(4+\frac{3}{2}\varepsilon,3+\varepsilon)]$; 
%finally, we split the part that is not visible from $(1,1)$, 
%which leads to three intervals: 
%$[(1,3+\varepsilon)-(2,3+\varepsilon)]$, 
%$[(3,3+\varepsilon)-(3+\varepsilon,3+\varepsilon)]$, 
%and
%$](3+\varepsilon,3+\varepsilon)-
%(4+\frac{3}{2}\varepsilon,3+\varepsilon)]$. 
%If we project back on row 3, 
%we obtain three intervals: 
%$[(1,3)-(2,3)]$, 
%$[(3,3)-(3,3)]$, 
%and
%$](3,3)-(4,3)]$. 
%We say that these intervals are ``consistent''%
%\footnote{We need a better word here.} 
%with the obstacles.  
%The first and last intervals can be delt with similarly 
%to the example in Figure~\ref{fig::succ1} (left).  
%The second interval, being a single point, 
%requires to generate new intervals.  

The remaining question is what $f$ value 
should be associated with these intervals.  
For $A^*$ to return the optimal solution, 
we need $f$ to be an underestimate of the actual value 
(except for the final node).  
The interval has the following semantics: 
the path that is currently being constructed 
should start from $s$, cross the parent $P$, 
then cross the interval, and finally reached the goal.  
The shortest path that belongs to this set 
has length $g^*(P) + min_{x \in I}(d(P,x) + h^*(x))$.  
The value $g^*(P)$ should be known at this stage 
(this is one advantage of $A^*$).  
However, the minimum factor is unknown, 
but it can be lower-bounded by $min_{x \in I}(d(P,x) + h(x))$.  
This formula is actually pretty simple to solve, as we now demonstrate.  

Let $z_1$ and $z_2$ be the two extreme points of the interval.  
Draw a direct line between the goal and the parent $P$ of the interval, 
as shown in Figure~\ref{fig::fvalue}.  
If the line crosses the interval in \textit{\u z}, then the value is h(P).  If the line passes on the left, 
then the value is $d(P,z_1)+h(z_1)$; 
otherwise, it is $d(P,z_2)+h(z_2)$.  
If the goal is between the parent and the interval, 
as is the case with $g_4$, 
then one needs to consider the mirrored version of $g_4$ 
(here $g'_4$).  

\begin{figure}[ht]
  \begin{center}
%    \includegraphics[scale=0.3]{images/fvalue}
    \input{tikz/fvalue}
  \end{center}
  \caption{Computing the minimum distance 
    to go from $p$ through the interval to the goal; 
    if the goal is $g_1$, the direct distance between $p$ and $g_1$; 
    if the goal is $g_2$ or $g_3$, 
    the shortest distance is the distance represented by the dashed lines.}
  \label{fig::fvalue}
\end{figure}

% EOF
This section now presents our search algorithm, dubbed \anya, short for
any-angle pathfinding.  \anya{} is a variant of A* that does not search on the
space of intervals of the grid, but instead on the space of intervals and
corners.

\begin{algorithm}[ht!]
  \input{algo/anya}
  \caption{Procedure \anya, an any-angle pathfinding algorithm}
  \label{algo::anya}
\end{algorithm}

The general layout of \anya{} is given in Algorithm~\ref{algo::anya}.  
Like A*, \anya{} keeps a priority queue called $open$ 
and based on the $f$ value.  
The algorithm stops when the target is poped from the queue.  
Now, whether the current node is a corner or an interval 
is dealt with differently by \anya: 
\begin{itemize}
\item 
  For a corner, the successors of the corner are computed 
  (method successors\_of\_corner presented later) 
  and are added to the priority queue --- 
  the method add\_edge deals with computing the $f$ value 
  (presented later), updating if necessary the parent of a node, 
  and sorting the priority queue.  
\item 
  If the node is an interval, \anya{} moves it 
  and computes the corners of the new interval 
  (for this purpose, the target is seen as a corner).  
  Then, the interval is split according to the corners, 
  i.e., producing all the intervals between two consecutive corners.  
  All these corners and intervals 
  are potential successors of the current interval; 
  however, we need to check that they are visible from parent $p$.  
  To check whether an interval is visible, 
  we check whether its middle point is.  
\end{itemize}

We illustrate the computation of the successors 
of interval $i = \langle [1,2],3,p\langle$ 
where $p = \langle1,1\rangle$ 
(cf. Figure~\ref{fig::succ1}, right).  
The move of $i$ produces 
the interval $i' = \langle [1,2.5],4,p\rangle$.  
The set of corners of $i'$ is $\{\langle 2,4\rangle\}$.  
The split of $i'$ hence produces two intervals: 
$is = \{
\langle [1,2],4,p\rangle,  
\langle [2,2.5],4,p\rangle
\}$.  
The single corner is visible from $p$.  
The point $c' = \langle 1.5,4\rangle$ is also visible from $p$, 
which means that the first interval is visible from $p$.  
On the other hand, the point $\langle 2.25,4\rangle$ 
is not visible from $p$, 
which means that the second interval is not visible from $p$.  
The successors of $i$ are therefore $c'$ 
and $\langle [1,2],4,p\rangle$.  

\paragraph*{}

A corner $\langle x,y\rangle$ has potentially four successors.  
The first two obvious successors 
are the intervals at rows $y-1$ and $y+1$.  
However, the optimal path may follow a horizontal section, 
and the corner could have a successor on the left or on the right.  

\begin{algorithm}
  \input{algo/successorsofcorner}
  \caption{Computing the successors of a corner.}
  \label{algo::successorsofacorner}
\end{algorithm}



\begin{figure}[tb]
  \begin{center}
\begin{tikzpicture}
\creategrid{6}{6}
\end{tikzpicture}
  \end{center}
\end{figure}
