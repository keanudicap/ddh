\section{Algorithm}
%The best online approaches for any-angle pathfinding consider 
%only the set of discrete points that define the grid.
%Since this strategy is insufficient to guarantee optimality 
%we will consider sets of discrete and intermediate points
%by taking them together as an interval.

\begin{defi}
\label{defi::interval}
A \emph{grid interval} $I$ is a set of contiguous pairwise visible points found
along any row of the grid.  Each interval is defined in terms 
of its endpoints $a$ and $b$. 
With the possible exception of $a$ and $b$, each interval
contains only intermediate and discrete non-corner points.
When $a$ (resp. $b$) is a corner point, or a discrete point from the edge of the map, 
$a$ (resp. $b$) is closed. Otherwise $a$ (resp. $b$) can be open or closed.
\end{defi}
Identifying intervals is simple: any row of the grid can be naturally divided
into maximally sized contiguous sets of traversable and non-traversable points.
Each set of traversable points forms a tentative interval which we may need to
split, possibly several times, until the only corner points are found at the
endpoints $a$ or $b$.
%We can identify maximal-size intervals along
%Given a traversable point $p$, found along any row the grid, it is easy
%to identify the maximal interval containing $p$.
%Simply project two horizontal lines away from $p$: $a \leftarrow p$ and 
%$p \rightarrow b$ and form a closed interval $I = [a, b]$.
%The points $a$ and $b$ are either the first
%discrete corner points along the respective horizontal line from $p$ or, 
%if the line intersects no corner points, the last discrete traversable point.
%The start point $s$ and target point $t$ necessitate special treatment:
%we will say that each one forms a closed single point interval $I = [a, b]$
%where $a = b = s$ (or $t$).
\\
A significant advantage of Anya is that we construct intervals on-the-fly.
This allows us to start answering queries immediately and for any discrete
start-target pair. Similar algorithms (e.g. Continuous Dijkstra) require
a preprocessing step before any queries can be answered and then only
from a single fixed start point. 
\begin{defi}
A \emph{search node} $n = (I, r)$ is a tuple where $I$ is an interval and 
$r \not \in I$ is a \emph{root} point chosen such that each $p \in I$  
is visible from $r$. 
The identity of the root node is either the start point or the most recent
turning point on a path to any $p \in I$.
\end{defi}
%During search we will use the root point of a node $n$ in order to
%identify its successors. 
%Each successor is constructed from 
The successors of a search node $n = (I, r)$ are  constructed from the 
set of traversable points found on the same row of the grid as $n$ and 
the rows immediately adjacent. 
We want to guarantee that successor nodes only contain points that
can be reached from the root $r$ via a local path which is \emph{taut}.
Taut simply means that if we ``pull'' on the endpoints of 
the path we cannot make it any shorter.

\begin{defi}
$(I', r')$ is a \emph{successor} of
$(I, r)$ if: \textbf{(i)} each $p' \in I'$ is reached
by a taut path $\langle r, p,  p' \rangle$ that begins
at $r$ and passes through some $p \in I$;
\textbf{(ii)} the subpath $\langle p, p' \rangle$ does not intersect any 
interval $J \neq I'$.
\end{defi}
We begin with the closed set of traversable points that are 
visible from $r$ through $I$ and divide this set into $1 \leq k$
adjacent closed grid intervals.
We will say that each such interval is \emph{observable} and 
generate for each a corresponding successor node 
$(I', r')$ with root $r' = r$.
\\
Not all successors are observable.
For example, the taut path from $r$ can intersect 
$I$ at an endpoint $b$ which is also a corner point.
In this case we reach a set of traversable points that 
are either adjacent to $I$ or adjacent to one of the
observable successors.
Each such point is visible from $p = b$ but not 
from $r$.  From this set of non-visible points we build a 
single half-open interval $I' = [a', b')$ s.t. $I'$ is open at the 
endpoint closest to $b$.
We will say $I'$ is \emph{non-observable} and generate a 
corresponding successor $(I', r')$ with root $r' = b$.  
Notice that if $b$ is a non-corner endpoint of $I$ there 
is also a set of traversable points that are not visible from $r$.
In this case however the path from $r$ to each such point $p'$ is 
not taut so we do not generate any successor.

%\begin{lemm}
%For any search node $(I, r)$: each non-observable successor 
%$(I'_1, r'_1)$ is adjacent to an observable node 
%$(I'_2, r'_2)$ s.t. $I'_1 \cup I'_2$ or $I \cup I'_2$ is a 
%contiguous closed interval.
%\end{lemm}
%\begin{proof}
%There are two cases to consider; each depending on the identity
%of the root node $r'_1$. If $r'_1 = b$ then $(I'_1, r')$ is
%
%\end{proof}


\section{Stuff that is not finished}
This further constraint allows us to bound the branching factor of each
node to just those neighbours which are immediately adjacent to and on
the same row as $n$ and visible neig
as $n$ or located on an immediately adjacent 
row next to $n$.

is another significant advantage of Anya: unlike other similar
algorithms that have a (e.g. Visibility Points) we avoid generating successors that 
are not immediately promising

We will look for optimal any-angle paths in the search space formed by
intervals appearing along the rows of the grid.
To evaluate a search node $n = (I, r$) we will select a point $p \in I$ 
which has a minimum $f$-value with respect to a target point $t$.
Although each interval can contain a large number of points it is easy
to identify the one having a minimum $f$-value: 
simply project a straight line $r \rightarrow t$ from the root point 
$r$ to the target point $t$ and choose the point $p \in I$ which 
lies at their intersection.
If $r \rightarrow t$ does not intersect $I$ we simply choose the point
$p$ as one of the two endpoints of $I$.

\begin{lemm}
For any tuple $(I, r)$ and target point $t$: 
\textbf{if} the line $r \rightarrow t$ intersects $I$ at a point
$p$ \textbf{then} $\forall p' \in I: f(p) \leq f(p')$;
\textbf{else}
%If $r \rightarrow t$ does not intersect $I$ then 
$p$ is one of the two endpoints of $I$ and 
$\forall p' \in I: f(p) \leq f(p')$.
\end{lemm}
\begin{proof}
We will prove the lemma by construction. First, suppose
$r \rightarrow t$ intersects $I$.
In this case it is enough to observe that $f(p)$ is computed 
by taking the length of the straight line $r \rightarrow t$.
This value is a minimum bound on the cost of any path from $r$ 
through $I$ and to $t$.
%which means $f(p)$ is minimum.
%there can be no alternative
%$p' \in I$ s.t.  $f(p') \le f(p)$.
Next, suppose $r \rightarrow t$ does not intersect $I$. 
There are two possibile scenarios, depending on whether $t$
belongs to a row of the grid which is above or below the row
containing $I$.
If $t$ belongs to a row above $I$ then $r \rightarrow t$
crosses the row of $I$ either to the left of $I$, in which
case $p = a$, or to the right of $I$, in which case $p = b$.
In either case $f(p)$ is a minimum bound on the cost of any
path from $r$ through $I$ and to $t$.
Finally $\ldots$
%target is above
%the interval $I$ and $r \rightarrow t$ 
%crosses the row containing $I$ at some point $p \not\in I$ or
%the target is below the interval and $r \rightarrow t$ never
%crosses the row containing $I$.
\end{proof}
%
%Our search nodes will comprise of tuples of the form $(I, r)$ where
%$I$ is an interval and $r$ is a \emph{root} point which can be
%either the start location or the most recent corner point on the path used
%to reach to $I$.
%Given any such tuple we require that each $p \in I$ is visible from $r$.
%\\

Definition~\ref{defi::intadj} bounds the branching factor of each 
search node to $O(W)$ and unlike other exact algortihms (e.g. visibility graphs)
allows us to defer the generation of any neighbours that are not 
immediately promising.
\\

Essentially, the reason why the existing algorithms are not optimal
is that the search is based on the grid intersections.  
However, because the final any-angle path 
may never cross these intersections, 
the $A^*$ $f$ value associated with the intersections
is not relevant.  
In this article, we propose to run the search not on the grid 
but instead on the edges of the graph.  

bla bla

From $n_1$, all the nodes that can be reached with a one step North 
(and potentially any fraction of West/East steps) will be considered.  
We call ``interval'' this set of nodes that are considered together.  

How should we then compute the successors of an interval?  
Look at Figure~\ref{fig::succ1} (left) 
where a North step is taken from the interval $[(1,3)-(4,3)]$
reached from node $(1,1)$.  
The (single) successor of the interval 
is simply computed by projecting the visibility cone 
(represented with dashed lines)
from $(1,1)$ to the next row.  
This leads to the interval $[(1,4)-(5+\frac{1}{2},4)]$.  
Obverse that, as a consequence, the parent of the interval 
(here $(1,1)$) must be kept together with the interval.  

\begin{figure}[ht]
  \begin{minipage}{0.5\linewidth}
  \begin{center}
    \input{tikz/ex2}
  \end{center}
  \end{minipage}
  \begin{minipage}{0.5\linewidth}
  \begin{center}
    \input{tikz/ex3}
  \end{center}
  \end{minipage}
  \caption{Computing the successors of an interval}
  \label{fig::succ1}
\end{figure}

There are more complicated situations, 
as presented in Figure~\ref{fig::succ1} (right).  
Here, we can see that an obstacle splits the interval 
in two separate intervals.  
We could define disjunct intervals, 
but it seems more natural to consider them independently.  

Furthermore, the path might turn at node $(3,3)$
(e.g., to reach node $(3,4)$
which is not directly accessible from $(1,1)$).  
The corner $(3,3)$ is therefore a successor of node $(1,1)$ 
and intervals should be built from this node.  

%Let us present more precisely how the successors are splitted.  
%From the interval $I = [(1,3)-(4,3)]$, 
%we assume that an epsilon step 
%(i.e., an infinitely small step North) is taken.  
%This step reveals how the interval will be splitted.  
%Therefore, we generate interval 
%$[(1,3+\varepsilon)-(4+\frac{3}{2}\varepsilon,3+\varepsilon)]$; 
%we then remove the parts that belong to the obstacle, 
%which produces the two intervals 
%$[(1,3+\varepsilon)-(2,3+\varepsilon)]$ 
%$[(3,3+\varepsilon)-(4+\frac{3}{2}\varepsilon,3+\varepsilon)]$; 
%finally, we split the part that is not visible from $(1,1)$, 
%which leads to three intervals: 
%$[(1,3+\varepsilon)-(2,3+\varepsilon)]$, 
%$[(3,3+\varepsilon)-(3+\varepsilon,3+\varepsilon)]$, 
%and
%$](3+\varepsilon,3+\varepsilon)-
%(4+\frac{3}{2}\varepsilon,3+\varepsilon)]$. 
%If we project back on row 3, 
%we obtain three intervals: 
%$[(1,3)-(2,3)]$, 
%$[(3,3)-(3,3)]$, 
%and
%$](3,3)-(4,3)]$. 
%We say that these intervals are ``consistent''%
%\footnote{We need a better word here.} 
%with the obstacles.  
%The first and last intervals can be delt with similarly 
%to the example in Figure~\ref{fig::succ1} (left).  
%The second interval, being a single point, 
%requires to generate new intervals.  

The remaining question is what $f$ value 
should be associated with these intervals.  
For $A^*$ to return the optimal solution, 
we need $f$ to be an underestimate of the actual value 
(except for the final node).  
The interval has the following semantics: 
the path that is currently being constructed 
should start from $s$, cross the parent $P$, 
then cross the interval, and finally reached the goal.  
The shortest path that belongs to this set 
has length $g^*(P) + min_{x \in I}(d(P,x) + h^*(x))$.  
The value $g^*(P)$ should be known at this stage 
(this is one advantage of $A^*$).  
However, the minimum factor is unknown, 
but it can be lower-bounded by $min_{x \in I}(d(P,x) + h(x))$.  
This formula is actually pretty simple to solve, as we now demonstrate.  

Let $z_1$ and $z_2$ be the two extreme points of the interval.  
Draw a direct line between the goal and the parent $P$ of the interval, 
as shown in Figure~\ref{fig::fvalue}.  
If the line crosses the interval in \textit{\u z}, then the value is h(P).  If the line passes on the left, 
then the value is $d(P,z_1)+h(z_1)$; 
otherwise, it is $d(P,z_2)+h(z_2)$.  
If the goal is between the parent and the interval, 
as is the case with $g_4$, 
then one needs to consider the mirrored version of $g_4$ 
(here $g'_4$).  

\begin{figure}[ht]
  \begin{center}
%    \includegraphics[scale=0.3]{images/fvalue}
    \input{tikz/fvalue}
  \end{center}
  \caption{Computing the minimum distance 
    to go from $p$ through the interval to the goal; 
    if the goal is $g_1$, the direct distance between $p$ and $g_1$; 
    if the goal is $g_2$ or $g_3$, 
    the shortest distance is the distance represented by the dashed lines.}
  \label{fig::fvalue}
\end{figure}

% EOF
This section now presents our search algorithm, dubbed \anya, short for
any-angle pathfinding.  \anya{} is a variant of A* that does not search on the
space of intervals of the grid, but instead on the space of intervals and
corners.

\begin{algorithm}[ht!]
  \input{algo/anya}
  \caption{Procedure \anya, an any-angle pathfinding algorithm}
  \label{algo::anya}
\end{algorithm}

The general layout of \anya{} is given in Algorithm~\ref{algo::anya}.  
Like A*, \anya{} keeps a priority queue called $open$ 
and based on the $f$ value.  
The algorithm stops when the target is poped from the queue.  
Now, whether the current node is a corner or an interval 
is dealt with differently by \anya: 
\begin{itemize}
\item 
  For a corner, the successors of the corner are computed 
  (method successors\_of\_corner presented later) 
  and are added to the priority queue --- 
  the method add\_edge deals with computing the $f$ value 
  (presented later), updating if necessary the parent of a node, 
  and sorting the priority queue.  
\item 
  If the node is an interval, \anya{} moves it 
  and computes the corners of the new interval 
  (for this purpose, the target is seen as a corner).  
  Then, the interval is split according to the corners, 
  i.e., producing all the intervals between two consecutive corners.  
  All these corners and intervals 
  are potential successors of the current interval; 
  however, we need to check that they are visible from parent $p$.  
  To check whether an interval is visible, 
  we check whether its middle point is.  
\end{itemize}

We illustrate the computation of the successors 
of interval $i = \langle [1,2],3,p\langle$ 
where $p = \langle1,1\rangle$ 
(cf. Figure~\ref{fig::succ1}, right).  
The move of $i$ produces 
the interval $i' = \langle [1,2.5],4,p\rangle$.  
The set of corners of $i'$ is $\{\langle 2,4\rangle\}$.  
The split of $i'$ hence produces two intervals: 
$is = \{
\langle [1,2],4,p\rangle,  
\langle [2,2.5],4,p\rangle
\}$.  
The single corner is visible from $p$.  
The point $c' = \langle 1.5,4\rangle$ is also visible from $p$, 
which means that the first interval is visible from $p$.  
On the other hand, the point $\langle 2.25,4\rangle$ 
is not visible from $p$, 
which means that the second interval is not visible from $p$.  
The successors of $i$ are therefore $c'$ 
and $\langle [1,2],4,p\rangle$.  

\paragraph*{}

A corner $\langle x,y\rangle$ has potentially four successors.  
The first two obvious successors 
are the intervals at rows $y-1$ and $y+1$.  
However, the optimal path may follow a horizontal section, 
and the corner could have a successor on the left or on the right.  

\begin{algorithm}
  \input{algo/successorsofcorner}
  \caption{Computing the successors of a corner.}
  \label{algo::successorsofacorner}
\end{algorithm}

